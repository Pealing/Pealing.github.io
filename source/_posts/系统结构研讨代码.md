---
title: 系统结构研讨代码
date: 2017-05-16 19:47:30
updated: 2017-05-16 19:47:30
tags:
---
系统结构研讨代码
<!--more-->

# 矩阵乘法
```cpp
#include <stdio.h>
#include <time.h>
#include <iostream>
#include <stdlib.h>
#include <string.h>

void GeneralMatrixMul(double *a,double *b,double *c,int n)
{
    int i,j,k;
    for(i = 0; i < n; i++)
    {
        for(j = 0; j < n;j++)
        {
            for(k = 0; k < n; k++)
            {
                c[i*n+j] += a[i*n +k]*b[k*n+j];

            }
        }
    }
}

//改变访问顺序
void LoopPermutationMatrixMul(double *a,double *b,double *c,int n)
{
    int i,j,k;
    for(i = 0;i<n;i++)
    {
        for(k=0;k<n;k++)
        {
            for(j=0;j<n;j++)
            {
                c[i*n+j]+=a[i*n+k]*b[k*n+j];
            }
        }
    }
}

//分块处理
void BlockMatrixMul(double *a,double *b,double *c,int n,int T)
{
    int i,j,k;
    int i1,j1,k1;
    for(i = 0;i < n;i+=T)
    {
        for(k = 0;k < n; k+=T)
        {
            for(j = 0;j < n;j+=T)
            {
                for(i1=i;i1<i+T;i1++)
                {
                    for(k1=k;k1<k+T;k1++)
                    {
                        for(j1=j;j1<j+T;j1++)
                        {
                            c[i1*n+j1]+=a[i1*n+k1]*b[k1*n+j1];
                        }
                    }
                }
            }
        }
    }
}

inline double compute_time(clock_t begin,clock_t end)
{
    return static_cast<double>(static_cast<double>((end -begin))/static_cast<double>(CLOCKS_PER_SEC));
}

void Test()
{
    int n,t;
    std::cout<<"Please input N: ";
    std::cin>>n;
    t=10;
   // std::cout<<"Please input T: ";
    //std::cin>>t;

    double *a =(double *)malloc(sizeof(double)*n*n);
    double *b =(double *)malloc(sizeof(double)*n*n);
    double *c =(double *)malloc(sizeof(double)*n*n);
    memset(a,0,sizeof(double)*n*n);
    memset(b,0,sizeof(double)*n*n);
    memset(c,0,sizeof(double)*n*n);

    //std::cout<<sizeof(double)<<' '<<sizeof(float)<<std::endl;
    clock_t start = clock();
    GeneralMatrixMul(a, b, c, n);
    std::cout<< compute_time(start,clock())<<std::endl;
    start=clock();
    LoopPermutationMatrixMul(a,b,c,n);
    std::cout<<compute_time(start,clock())<<std::endl;
    start=clock();
    BlockMatrixMul(a,b,c,n,t);
    std::cout<<compute_time(start,clock())<<std::endl;
}

int main()
{
    while(1)
    {
        Test();
    }
    return 0;
}
```

# 计算cache容量

```cpp
#include <random>
#include <iostream>
#include <ctime>
#include <algorithm>
#include <vector>
#define KB(x) ((size_t) (x)  <<10)

using namespace std;

int main()
{
    //需要测试的数组大小
    vector<size_t> sizes_KB;
    for (int i = 1; i < 18; i++){sizes_KB.push_back(1 << i);}

    random_device rd;//随机数生成
    mt19937 gen(rd());

    for (size_t size: sizes_KB)
    {
        uniform_int_distribution<> dis(0, KB(size)-1);// 以离散型均匀分布方式产生 int 乱数
        vector<char> memory(KB(size));//创建一个指定大小的连续内存块
        
        fill(memory.begin(), memory.end(), 1);//memory中的元素重置为1

        int dummy = 0;//用这个变量避免编译器对下面的循环进行优化

        //在内存块上进行大量的随机访问，并计时
        clock_t begin = clock();
        for (int i = 0; i < (1<<25); i++){dummy += memory[dis(gen)];}
        clock_t end = clock();

        double elapsed_secs = double(end - begin) / CLOCKS_PER_SEC;
        cout << size << " KB, " << elapsed_secs << "secs, dummy:" << dummy << endl;
    }
    cin.get();
}
```